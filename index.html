<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazbear Admin - Registro Elettronico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: radial-gradient(circle, #2d1b14 0%, #f4f4f2 100%); background-attachment: fixed; color: #1a1a1a; }
        .glass { background: rgba(45, 27, 20, 0.9); border: 2px solid #d4af37 ; backdrop-filter: blur(10px) ;box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6); border-radius: 15px;  }
        .tab-content { display: none; }
        .active-tab { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="h-16 border-b border-zinc-800 bg-[#f4f4f2] flex items-center justify-between px-6 z-50 shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-red-700 rounded-lg flex items-center justify-center shadow-lg text-xl">üêª</div>
            <h1 class="font-black text-sm uppercase italic text-zinc-900">Fazbear <span class="text-red-600">Classroom</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="user-profile" class="hidden flex items-center gap-3 bg-zinc-200/50 p-1.5 rounded-full border border-zinc-800">
                <img id="user-avatar" src="" class="w-7 h-7 rounded-full border border-red-600">
                <span id="user-name" class="text-[10px] font-bold text-zinc-900 pr-2 uppercase">---</span>
            </div>
            <button id="login-btn" onclick="window.loginDiscord()" class="bg-red-700 text-white text-[9px] font-black px-4 py-2 rounded-lg uppercase shadow-lg hover:bg-red-600 transition-all">Login Discord</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-72 border-r border-zinc-300 bg-transparent flex flex-col shrink-0">
            <div class="p-4 border-b border-zinc-200">
                <input type="text" id="sidebar-search" oninput="window.searchSidebar()" placeholder="Cerca profilo..." class="w-full bg-zinc-200 border border-zinc-300 rounded-xl px-4 py-2 text-xs text-black outline-none focus:border-red-700 transition-all">
            </div>
            <div id="entity-list" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-6">
                <p class="text-[9px] text-zinc-600 uppercase font-black animate-pulse text-center">Inizializzazione database...</p>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-transparent p-6 custom-scroll relative">
            <div id="empty-view" class="h-full flex items-center justify-center opacity-40 uppercase font-black text-xs tracking-widest text-center">
                Seleziona un'entit√† dal database<br>per visualizzare i record
            </div>

            <div id="main-view" class="hidden max-w-4xl mx-auto space-y-6">
                <div class="glass p-8 rounded-[2rem] border-l-4 border-red-700 relative overflow-hidden">
                    <div id="bg-initial" class="absolute right-0 top-0 p-4 text-[10rem] font-black text-white/[0.02] pointer-events-none italic select-none">?</div>
                    <div class="relative z-10">
                        <span id="tag-role" class="px-2 py-1 bg-red-700 text-[9px] font-black uppercase rounded text-white shadow-sm">---</span>
                        <h2 id="display-name" class="text-5xl font-extrabold text-[#fef3c7] mt-2 italic uppercase leading-none tracking-tighter">---</h2>
                        <div id="stats-bar" class="mt-4 flex gap-4">
                            <div class="bg-zinc-900/50 p-2 px-4 rounded-lg border border-zinc-800">
                                <p class="text-[8px] uppercase font-bold text-[#d4af37]">Media Rendimento</p>
                                <p id="media-val" class="text-lg font-black text-red-500">0.0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabs-nav" class="flex gap-1 bg-zinc-900/80 p-1 rounded-xl border border-zinc-800 w-fit">
                    <button onclick="window.showTab('voti')" id="btn-voti" class="px-5 py-2 text-[9px] font-black uppercase rounded-lg transition-all">Voti</button>
                    <button onclick="window.showTab('note')" id="btn-note" class="px-5 py-2 text-[9px] font-black uppercase rounded-lg transition-all">Note e Compiti</button>
                    <button onclick="window.showTab('pagella')" id="btn-pagella" class="px-5 py-2 text-[9px] font-black uppercase rounded-lg transition-all">Pagella</button>
                </div>

                <div id="admin-panel" class="hidden glass p-6 rounded-2xl border border-red-900/30 bg-red-900/5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="admin-title" class="text-[10px] font-black uppercase text-red-500 italic">Accesso Autorizzato</h3>
                        <input id="input-data-custom" type="date" class="bg-zinc-900 border border-zinc-800 rounded-lg p-1.5 text-[10px] text-white outline-none focus:border-red-700">
                    </div>
                    <div class="grid gap-4">
    <div class="flex gap-2">
        <input id="input-voto" type="number" step="0.5" placeholder="Voto" class="bg-zinc-900 border border-zinc-800 rounded-lg p-2.5 text-xs w-20 text-white outline-none focus:border-red-700">
        
        <select id="input-materia" class="bg-zinc-900 border border-zinc-800 rounded-lg p-2.5 text-xs flex-1 text-white outline-none focus:border-red-700 appearance-none cursor-pointer">
            <option value="" disabled selected>Materia</option>
            <option value="matematica">Matematica</option>
            <option value="fisica">Fisica</option>
            <option value="scienze">Scienze</option>
            <option value="arte">Arte</option>
            <option value="musica">Musica</option>
            <option value="inglese">Inglese</option>
            <option value="francese">Francese</option>
            <option value="spagnolo">Spagnolo</option>
            <option value="ginnastica">Ginnastica</option>
            <option value="geostoria">Geostoria</option>
            <option value="storia">Storia</option>
            <option value="filosofia">Filosofia</option>
            <option value="italiano">Italiano</option>
            <option value="latino">Latino</option>
            <option value="religione">Religione</option>
            <option value="magia">Magia</option>
            <option value="cinese">Cinese</option>
            <option value="tedesco">Tedesco</option>
            <option value="sport">Sport</option>
        </select>

        <button onclick="window.addEntry('voti')" class="bg-red-700 text-white text-[9px] font-black px-4 py-2 rounded-lg uppercase shadow-lg hover:bg-red-600 transition-all">Registra</button>
    </div>

    <div class="flex gap-2">
        <input id="input-nota" type="text" placeholder="Scrivi una nota ufficiale..." class="bg-zinc-900 border border-zinc-800 rounded-lg p-2.5 text-xs flex-1 text-white outline-none focus:border-red-700">
        <button onclick="window.addEntry('note')" class="bg-amber-600 text-white text-[9px] font-black px-4 py-2 rounded-lg uppercase shadow-lg hover:bg-amber-500 transition-all">Invia Nota</button>
    </div>

    <div class="flex gap-2 mt-2">
        <input id="input-compito-testo" type="text" placeholder="Assegna un compito..." class="bg-zinc-900 border border-zinc-800 rounded-lg p-2.5 text-xs flex-1 text-white outline-none focus:border-red-700">
        
        <select id="input-compito-materia" class="bg-zinc-900 border border-zinc-800 rounded-lg p-2.5 text-xs w-32 text-white outline-none focus:border-red-700 appearance-none cursor-pointer">
            <option value="" disabled selected>Materia</option>
            <option value="matematica">Matematica</option>
            <option value="fisica">Fisica</option>
            <option value="scienze">Scienze</option>
            <option value="arte">Arte</option>
            <option value="musica">Musica</option>
            <option value="inglese">Inglese</option>
            <option value="francese">Francese</option>
            <option value="spagnolo">Spagnolo</option>
            <option value="ginnastica">Ginnastica</option>
            <option value="geostoria">Geostoria</option>
            <option value="storia">Storia</option>
            <option value="filosofia">Filosofia</option>
            <option value="italiano">Italiano</option>
            <option value="latino">Latino</option>
            <option value="religione">Religione</option>
            <option value="magia">Magia</option>
            <option value="cinese">Cinese</option>
            <option value="tedesco">Tedesco</option>
            <option value="sport">Sport</option>
        </select>
        <button onclick="window.addEntry('compiti')" class="bg-blue-700 text-white text-[9px] font-black px-4 py-2 rounded-lg uppercase shadow-lg hover:bg-blue-600 transition-all">Assegna</button>
    </div>
</div>
                </div>

                <div id="content-area">
                    <div id="tab-voti" class="tab-content active-tab">
                        <div class="glass rounded-xl overflow-hidden border border-zinc-800">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-zinc-900/50 text-[9px] uppercase font-black text-zinc-500 border-b border-zinc-800">
                                    <tr>
                                        <th class="p-4">Materia</th>
                                        <th class="p-4">Data</th>
                                        <th class="p-4 text-right">Voto</th>
                                    </tr>
                                </thead>
                                <tbody id="voti-body" class="divide-y divide-zinc-800/50"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="tab-note" class="tab-content">
                        <h4 class="text-[10px] font-black uppercase text-zinc-400 mb-4 tracking-widest">Note Disciplinari e Compiti</h4>
                        <div id="note-container" class="grid gap-3"></div>
                    </div>
                    <div id="tab-pagella" class="tab-content">
                        <div id="pagella-view" class="glass p-12 rounded-[3rem] text-center border border-zinc-800">
                            <p class="text-[10px] font-black uppercase text-zinc-500 mb-4">Documento di Valutazione</p>
                            <div id="pagella-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCDlju6uXmXj3fRLYge-ya65J8ditM6rnM", 
            authDomain: "fnaf-school-bot.firebaseapp.com", 
            projectId: "fnaf-school-bot", 
            storageBucket: "fnaf-school-bot.firebasestorage.app", 
            appId: "1:862125328005:web:463c6fb776a0f7e1e24bec" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.currentUserId = null;
        window.currentUserData = null;
        window.selectedEntityId = null;

        window.loginDiscord = () => {
            const uri = encodeURIComponent(window.location.origin + window.location.pathname);
            window.location.href = `https://discord.com/api/oauth2/authorize?client_id=1469524509106110484&redirect_uri=${uri}&response_type=token&scope=identify`;
        };

        signInAnonymously(auth).then(() => {
            onSnapshot(collection(db, 'artifacts', 'fnaf-school-bot', 'public', 'data', 'assignments'), (snap) => {
                const list = document.getElementById('entity-list');
                const groups = { 'Personale Scolastico': [] };
                snap.forEach(d => {
                    const s = d.data();
                    const key = s.classe && s.classe !== "None" ? `Classe ${s.classe}` : 'Personale Scolastico';
                    if(!groups[key]) groups[key] = [];
                    groups[key].push({id: d.id, ...s});
                });

                list.innerHTML = Object.keys(groups).sort().map(g => `
                    <div class="sidebar-group">
                        <h3 class="text-[10px] font-black uppercase text-zinc-800 mb-2 tracking-widest border-b border-zinc-300 pb-1">${g}</h3>
                        ${groups[g].map(s => `
                            <button onclick="window.loadData('${s.id}', ${JSON.stringify(s).replace(/"/g, '&quot;')})" 
                                    class="w-full text-left p-2.5 rounded-xl hover:bg-zinc-200 transition-all text-xs text-black mb-1 border border-transparent hover:border-zinc-300 flex items-center justify-between group">
                                <span class="font-bold">${s.name}</span> 
                                <span class="text-[8px] text-zinc-500 uppercase">${s.role}</span>
                            </button>`).join('')}
                    </div>
                `).join('');
            });
            checkAuth();
        });

        window.loadData = (id, s) => {
            window.selectedEntityId = id;
            document.getElementById('empty-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('display-name').innerText = s.name;
            document.getElementById('tag-role').innerText = s.role;
            document.getElementById('bg-initial').innerText = s.name[0];

            const roleStr = s.role.toLowerCase();
            const isStaffProfile = roleStr.includes('prof') || roleStr.includes('preside') || roleStr.includes('bidello') || roleStr.includes('docente');
            
            document.getElementById('stats-bar').style.display = isStaffProfile ? 'none' : 'flex';
            document.getElementById('btn-voti').style.display = isStaffProfile ? 'none' : 'block';
            document.getElementById('btn-pagella').style.display = isStaffProfile ? 'none' : 'block';
            
            window.showTab(isStaffProfile ? 'note' : 'voti');

            onSnapshot(doc(db, 'artifacts', 'fnaf-school-bot', 'public', 'data', 'records', id), d => {
                const data = d.exists() ? d.data() : {};
                const vList = data.voti || data.grades || [];
                let sum = 0; 
                vList.forEach(v => sum += parseFloat(v.voto || v.value || 0));
                const media = vList.length > 0 ? (sum / vList.length).toFixed(1) : "0.0";
                
                document.getElementById('media-val').innerText = media;
                
                document.getElementById('voti-body').innerHTML = vList.map((v, index) => `
                    <tr class="group hover:bg-white/[0.02]">
                        <td class="p-4 font-bold text-[#fef3c7] uppercase text-[10px] tracking-tight">${v.materia || v.subject}</span>
                        <span class="text-[7px] text-zinc-500 uppercase font-black mt-1 italic">Firma: ${v.teacher || "Docente Ignoto"}
                        </div>
                    </td>
                        <td class="p-4 text-[9px] text-[#fef3c7]/60">${v.data || v.date || '---'}</td>
                        <td class="p-4 font-black text-right ${ (v.voto || v.value) >= 6 ? 'text-green-500' : 'text-red-500' }">
                            <div class="flex items-center justify-end gap-3">
                                <span>${v.voto || v.value}</span>
                                ${(window.currentUserData && (window.currentUserData.role.toLowerCase().includes('prof') || window.currentUserData.role.toLowerCase().includes('preside') || window.currentUserData.role.toLowerCase().includes('direttore') || window.currentUserData.role.toLowerCase().includes('vice'))) ? `
                                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                        <button onclick="window.editEntry('voti', ${index})" class="text-blue-500 text-[8px] font-black uppercase">Modifica</button>
                                        <button onclick="window.deleteEntry('voti', ${index})" class="text-red-900 hover:text-red-500 text-[8px] font-black uppercase">Elimina</button>
                                    </div>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="3" class="p-10 text-center text-black opacity-100 text-[10px] uppercase font-black tracking-widest">Nessun record</td></tr>';
                
                // RENDER NOTE E COMPITI INSIEME
                const noteHtml = (data.notes || data.note || []).map((n, index) => `
                    <div class="group p-4 glass rounded-xl border-l-4 border-amber-600 bg-amber-600/5 text-xs italic">
                        <div class="flex justify-between items-start">
                            <span>"${n.text || n.testo}"</span>
                            ${(window.currentUserData && (window.currentUserData.role.toLowerCase().includes('prof') || window.currentUserData.role.toLowerCase().includes('preside') || window.currentUserData.role.toLowerCase().includes('direttore') || window.currentUserData.role.toLowerCase().includes('vice'))) ? 
                            `<button onclick="window.deleteEntry('note', ${index})" class="opacity-0 group-hover:opacity-100 text-red-800 hover:text-red-500 text-[8px] font-black uppercase">Elimina</button>` : ''}
                        </div>
                        <div class="mt-2 text-[8px] opacity-40 uppercase font-black tracking-widest">${n.date || n.data} ‚Äî Emesso da: ${n.teacher || n.autore}</div>
                    </div>`).join('');

                const compitiHtml = (data.compiti || []).map((c, index) => `
                    <div class="group p-4 glass rounded-xl border-l-4 border-blue-600 bg-blue-600/5 text-xs">
                        <div class="flex justify-between items-start">
                            <div class="flex flex-col">
                                <span class="text-blue-400 font-black uppercase text-[8px] tracking-widest mb-1">${c.materia}</span>
                                <span class="text-zinc-200">${c.testo}</span>
                            </div>
                            ${(window.currentUserData && (window.currentUserData.role.toLowerCase().includes('prof') || window.currentUserData.role.toLowerCase().includes('preside') || window.currentUserData.role.toLowerCase().includes('direttore') || window.currentUserData.role.toLowerCase().includes('vice'))) ? 
                            `<button onclick="window.deleteEntry('compiti', ${index})" class="opacity-0 group-hover:opacity-100 text-red-800 hover:text-red-500 text-[8px] font-black uppercase">Elimina</button>` : ''}
                        </div>
                        <div class="mt-2 text-[8px] opacity-40 uppercase font-black tracking-widest">${c.data} ‚Äî Assegnato da: ${c.autore}</div>
                    </div>`).join('');

                document.getElementById('note-container').innerHTML = (noteHtml + compitiHtml) || '<p class="text-center opacity-30 text-[10px] uppercase font-black py-10 tracking-[0.2em]">Nessun record</p>';
                
                document.getElementById('pagella-content').innerHTML = `<h4 class="text-7xl font-black ${media >= 6 ? 'text-green-600' : 'text-red-600'} italic tracking-tighter">${media}</h4><div class="mt-4 px-4 py-1 inline-block rounded-full bg-zinc-900 border border-zinc-800 text-[10px] font-black uppercase text-white">${media >= 6 ? 'Promosso' : 'Debito'}</div>`;
            });
        };

        window.addEntry = async (type) => {
            if(!window.currentUserData) return alert("Errore: Login non effettuato!");
            const ruolo = window.currentUserData.role.toLowerCase();
            const isStaff = ruolo.includes('prof') || ruolo.includes('docente') || ruolo.includes('preside') || ruolo.includes('vice') || ruolo.includes('direttore');
            if (!isStaff) return alert("‚õî Accesso negato!");
            if (window.currentUserId === window.selectedEntityId) return alert("‚õî Azione non consentita su se stessi!");

            const ref = doc(db, 'artifacts', 'fnaf-school-bot', 'public', 'data', 'records', window.selectedEntityId);
            const inputData = document.getElementById('input-data-custom').value;
            let dateStr = inputData ? `${inputData.split('-')[2]}/${inputData.split('-')[1]}/${inputData.split('-')[0]}` : new Date().toLocaleDateString('it-IT');
            const firma = `${document.getElementById('user-name').innerText} (${window.currentUserData.role})`;
            const isHighStaff = ruolo.includes('preside') || ruolo.includes('direttore') || ruolo.includes('vice');
             const elMateria = type === 'voti' ? document.getElementById('input-materia') : document.getElementById('input-compito-materia');
    const m = elMateria.value.toLowerCase().trim();
            if ((type === 'voti' || type === 'compiti') && !isHighStaff) {
        const materieDelProf = (window.currentUserData.materie || []).map(val => val.toLowerCase().trim());
        if (!m) return alert("‚ùå Seleziona una materia dal menu!");
        if (!materieDelProf.includes(m)) {
        return alert("‚ùå Non sei abilitato a gestire " + m.toUpperCase() + "!");
    }
  
            try {
                if(type === 'voti') {
        const v = document.getElementById('input-voto').value;
        if(!v || !m) return alert("Compila voto e materia!");
        await setDoc(ref, { 
            voti: arrayUnion({ voto: v, materia: m, data: dateStr, teacher: firma }),
            grades: arrayUnion({ value: parseFloat(v), subject: m, date: dateStr, teacher: firma })
        }, { merge: true });
                    document.getElementById('input-voto').value = ""; 
                } else if (type === 'note') {
                    const t = document.getElementById('input-nota').value;
                    if(!t) return alert("Scrivi la nota!");
                    await setDoc(ref, { 
                        note: arrayUnion({ testo: t, autore: firma, data: dateStr }),
                        notes: arrayUnion({ text: t, teacher: firma, date: dateStr })
                    }, { merge: true });
                    document.getElementById('input-nota').value = "";
                } else if (type === 'compiti') {
                    const t = document.getElementById('input-compito-testo').value;
                
                    if(!t || !m) return alert("Scrivi il compito e la materia!");
                    await setDoc(ref, { 
                        compiti: arrayUnion({ testo: t, materia: m, data: dateStr, autore: firma })
                    }, { merge: true });
                    document.getElementById('input-compito-testo').value = "";
                    document.getElementById('input-compito-materia').value = "";
                }
                alert("‚úÖ Registrato con successo!");
            } catch (e) { alert("Errore: " + e.message); }
        };
            try {
                if(type === 'voti') {
        const v = document.getElementById('input-voto').value;
        if(!v || !m) return alert("Compila voto e materia!");
        await setDoc(ref, { 
            voti: arrayUnion({ voto: v, materia: m, data: dateStr }),
            grades: arrayUnion({ value: parseFloat(v), subject: m, date: dateStr, teacher: firma })
        }, { merge: true });
                    document.getElementById('input-voto').value = ""; 
                } else if (type === 'note') {
                    const t = document.getElementById('input-nota').value;
                    if(!t) return alert("Scrivi la nota!");
                    await setDoc(ref, { 
                        note: arrayUnion({ testo: t, autore: firma, data: dateStr }),
                        notes: arrayUnion({ text: t, teacher: firma, date: dateStr })
                    }, { merge: true });
                    document.getElementById('input-nota').value = "";
                } else if (type === 'compiti') {
                    const t = document.getElementById('input-compito-testo').value;
                
                    if(!t || !m) return alert("Scrivi il compito e la materia!");
                    await setDoc(ref, { 
                        compiti: arrayUnion({ testo: t, materia: m, data: dateStr, autore: firma })
                    }, { merge: true });
                    document.getElementById('input-compito-testo').value = "";
                    document.getElementById('input-compito-materia').value = "";
                }
                alert("‚úÖ Registrato con successo!");
            } catch (e) { alert("Errore: " + e.message); }
        };

        window.editEntry = async (type, index) => {
    const r = window.currentUserData.role.toLowerCase();
    const isHighStaff = r.includes('preside') || r.includes('direttore') || r.includes('vice');
    const firma = `${document.getElementById('user-name').innerText} (${window.currentUserData.role})`;
    
    if (!(r.includes('prof') || r.includes('docente') || isHighStaff)) return alert("‚õî Azione non consentita!");
    
    const ref = doc(db, 'artifacts', 'fnaf-school-bot', 'public', 'data', 'records', window.selectedEntityId);
    const snap = await getDoc(ref);
    const data = snap.data();

    if (type === 'voti') {
        const vOld = data.voti || []; 
        const materiaVoto = vOld[index].materia.toLowerCase().trim();
        
        // Controllo permessi materia
        if (!isHighStaff) {
            const materieDelProf = (window.currentUserData.materie || []).map(val => val.toLowerCase().trim());
            if (!materieDelProf.includes(materiaVoto)) {
                return alert("‚ùå Non puoi modificare voti di " + materiaVoto.toUpperCase() + "!");
            }
        }

        const gOld = data.grades || [];
        const nuovoV = prompt("Nuovo voto:", vOld[index].voto);
        const nuovaM = prompt("Nuova materia:", vOld[index].materia);
        
        if (nuovoV && nuovaM) {
            vOld[index].voto = nuovoV; 
            vOld[index].materia = nuovaM;
            // Se vuoi tracciare chi ha modificato, puoi aggiungere:
            vOld[index].teacher = firma; 

            if (gOld[index]) { 
                gOld[index].value = parseFloat(nuovoV); 
                gOld[index].subject = nuovaM; 
                gOld[index].teacher = firma; 
            }
            
            await updateDoc(ref, { voti: vOld, grades: gOld });
            alert("‚úÖ Voto aggiornato!");
        }
    } 
}; 

        window.deleteEntry = async (type, index) => {
            const r = window.currentUserData.role.toLowerCase();
            if(!(r.includes('prof') || r.includes('preside') || r.includes('direttore') || r.includes('vice'))) return alert("‚õî Azione non consentita!");
            const isHighStaff = r.includes('preside') || r.includes('direttore') || r.includes('vice');
            const firma = `${document.getElementById('user-name').innerText} (${window.currentUserData.role})`;
            if(!confirm("Sicuro di voler eliminare questo record?")) return;
            if(!(r.includes('prof') || r.includes('docente') || isHighStaff)) return alert("‚õî Azione non consentita!");
            
            const ref = doc(db, 'artifacts', 'fnaf-school-bot', 'public', 'data', 'records', window.selectedEntityId);
            const snap = await getDoc(ref);
            const data = snap.data();
            
            if(type === 'voti') {
            const vOld = data.voti || []; 
            const gOld = data.grades || [];
            const materiaVoto = vOld[index].materia.toLowerCase().trim();
           if (!isHighStaff) {
          const materieDelProf = (window.currentUserData.materie || []).map(val => val.toLowerCase().trim());
          if (!materieDelProf.includes(materiaVoto)) {
          return alert("‚ùå Non puoi eliminare voti di " + materiaVoto.toUpperCase() + " di un altro collega!");
        }
    }
                vOld.splice(index, 1); 
                gOld.splice(index, 1);
                await updateDoc(ref, { voti: vOld, grades: gOld });
                alert("üóëÔ∏è Voto eliminato correttamente.");
            
            } else if (type === 'note') {
                const nOld = data.note || []; const nsOld = data.notes || [];
                nOld.splice(index, 1); nsOld.splice(index, 1);
                await updateDoc(ref, { note: nOld, notes: nsOld });
                
            } else if (type === 'compiti') {
                const cOld = data.compiti || [];
                cOld.splice(index, 1);
                await updateDoc(ref, { compiti: cOld });
                alert("üóëÔ∏è Compito eliminato.");
            }
        };

        window.showTab = (tabName) => {
            ['voti','note','pagella'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if(el) el.className = t === tabName ? 'tab-content active-tab' : 'tab-content';
                const btn = document.getElementById(`btn-${t}`);
                if(btn) btn.className = t === tabName ? 'px-5 py-2 text-[9px] font-black uppercase rounded-lg bg-red-700 text-white shadow-lg' : 'px-5 py-2 text-[9px] font-black uppercase rounded-lg text-zinc-500 hover:text-white transition-all';
            });
        };

        window.searchSidebar = () => {
            const query = document.getElementById('sidebar-search').value.toLowerCase();
            document.querySelectorAll('#entity-list button').forEach(btn => {
                btn.style.display = btn.innerText.toLowerCase().includes(query) ? 'flex' : 'none';
            });
        };

        async function checkAuth() {
            const params = new URLSearchParams(window.location.hash.slice(1));
            const token = params.get('access_token');
            if (token) {
                try {
                    const res = await fetch('https://discord.com/api/users/@me', { headers: { Authorization: `Bearer ${token}` } });
                    const user = await res.json();
                    window.currentUserId = user.id;
                    document.getElementById('login-btn').classList.add('hidden');
                    document.getElementById('user-profile').classList.remove('hidden');
                    document.getElementById('user-name').innerText = user.username;
                    document.getElementById('user-avatar').src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;

                    const uDoc = await getDoc(doc(db, 'artifacts', 'fnaf-school-bot', 'public', 'data', 'assignments', user.id));
                    if(uDoc.exists()) {
                        window.currentUserData = uDoc.data();
                        const r = window.currentUserData.role.toLowerCase();
                        if (r.includes('prof') || r.includes('docente') || r.includes('preside') || r.includes('vice') || r.includes('direttore')) {
                            document.getElementById('admin-panel').classList.remove('hidden');
                            document.getElementById('admin-title').innerText = `Gestione: ${window.currentUserData.role}`;
                        }
                    }
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) { console.error("Errore Auth:", e); }
            }
        }
    </script>
</body>
</html>
